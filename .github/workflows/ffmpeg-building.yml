name: FFmpeg Build

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1.3'
        type: string

env:
  FFMPEG_VERSION: ${{ inputs.ffmpeg_version }}

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (native runners)
          - os: ubuntu-24.04
            target: linux
            arch: x86_64
            artifact_name: ffmpeg-linux.zip
          - os: ubuntu-24.04-arm
            target: linux
            arch: arm64
            artifact_name: ffmpeg-linux-arm64.zip

          # Windows (native runners)
          - os: windows-2025
            target: windows
            arch: x86_64
            artifact_name: ffmpeg-windows.zip
          - os: windows-11-arm
            target: windows
            arch: arm64
            artifact_name: ffmpeg-windows-arm64.zip

          # macOS (native runners)
          - os: macos-15-intel
            target: macos
            arch: x86_64
            artifact_name: ffmpeg-macos.zip
          - os: macos-15
            target: macos
            arch: arm64
            artifact_name: ffmpeg-macos-arm64.zip

          # # Android (commented out - requires cross-compile or emulator)
          # - os: ubuntu-24.04
          #   target: android
          #   arch: x86_64
          #   artifact_name: ffmpeg-android.zip
          #   cross: true
          #   ndk_abi: x86_64
          # - os: ubuntu-24.04-arm
          #   target: android
          #   arch: arm64
          #   artifact_name: ffmpeg-android-arm64.zip
          #   cross: true
          #   ndk_abi: arm64-v8a

    runs-on: ${{ matrix.os }}
    name: Build FFmpeg (${{ matrix.target }}-${{ matrix.arch }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      # ============================================
      # LINUX DEPENDENCIES (native builds)
      # ============================================
      - name: Install dependencies (Linux)
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            yasm \
            pkg-config \
            git \
            cmake \
            meson \
            ninja-build \
            texinfo \
            wget \
            zip \
            \
            libx264-dev \
            libx265-dev \
            libvpx-dev \
            libfdk-aac-dev \
            libmp3lame-dev \
            libopus-dev \
            libvorbis-dev \
            libtheora-dev \
            libass-dev \
            libfreetype-dev \
            libfontconfig1-dev \
            libfribidi-dev \
            libharfbuzz-dev \
            libgnutls28-dev \
            libsdl2-dev \
            libaom-dev \
            libdav1d-dev \
            librav1e-dev \
            libsvtav1-dev \
            libwebp-dev \
            libsoxr-dev \
            libvidstab-dev \
            libzimg-dev \
            libzmq3-dev \
            libopencore-amrnb-dev \
            libopencore-amrwb-dev \
            libvo-amrwbenc-dev \
            libspeex-dev \
            libshine-dev \
            libtwolame-dev \
            libwavpack-dev \
            libgsm1-dev \
            libbluray-dev \
            libgme-dev \
            libopenmpt-dev \
            librubberband-dev \
            libsrt-gnutls-dev \
            libssh-dev \
            libxml2-dev \
            libdrm-dev \
            libva-dev \
            libvdpau-dev \
            ocl-icd-opencl-dev \
            liblzma-dev \
            libbz2-dev \
            libsnappy-dev \
            libopenjp2-7-dev \
            libopenal-dev \
            libcdio-dev \
            libcdio-paranoia-dev \
            libbs2b-dev \
            libcaca-dev \
            libpulse-dev \
            libv4l-dev \
            libxcb1-dev \
            libxcb-shm0-dev \
            libxcb-xfixes0-dev \
            libxcb-shape0-dev \
            libxvidcore-dev \
            libzvbi-dev \
            ladspa-sdk \
            libjack-jackd2-dev \
            libmodplug-dev \
            liblilv-dev \
            libmysofa-dev \
            librsvg2-dev \
            libtesseract-dev \
            libchromaprint-dev \
            frei0r-plugins-dev \
            libplacebo-dev \
            libvulkan-dev \
            glslang-dev \
            libshaderc-dev \
            libaribb24-dev \
            liblc3-dev \
            librist-dev \
            libvmaf-dev

      # ============================================
      # WINDOWS DEPENDENCIES (native builds with MSYS2)
      # ============================================
      - name: Setup MSYS2 (Windows)
        if: matrix.target == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            base-devel
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-nasm
            mingw-w64-ucrt-x86_64-yasm
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-meson
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-pkg-config
            zip
            wget
            git
            mingw-w64-ucrt-x86_64-x264
            mingw-w64-ucrt-x86_64-x265
            mingw-w64-ucrt-x86_64-libvpx
            mingw-w64-ucrt-x86_64-fdk-aac
            mingw-w64-ucrt-x86_64-lame
            mingw-w64-ucrt-x86_64-opus
            mingw-w64-ucrt-x86_64-libvorbis
            mingw-w64-ucrt-x86_64-libtheora
            mingw-w64-ucrt-x86_64-libass
            mingw-w64-ucrt-x86_64-freetype
            mingw-w64-ucrt-x86_64-fontconfig
            mingw-w64-ucrt-x86_64-fribidi
            mingw-w64-ucrt-x86_64-harfbuzz
            mingw-w64-ucrt-x86_64-gnutls
            mingw-w64-ucrt-x86_64-SDL2
            mingw-w64-ucrt-x86_64-aom
            mingw-w64-ucrt-x86_64-dav1d
            mingw-w64-ucrt-x86_64-rav1e
            mingw-w64-ucrt-x86_64-svt-av1
            mingw-w64-ucrt-x86_64-libwebp
            mingw-w64-ucrt-x86_64-libsoxr
            mingw-w64-ucrt-x86_64-vid.stab
            mingw-w64-ucrt-x86_64-zimg
            mingw-w64-ucrt-x86_64-zeromq
            mingw-w64-ucrt-x86_64-speex
            mingw-w64-ucrt-x86_64-twolame
            mingw-w64-ucrt-x86_64-wavpack
            mingw-w64-ucrt-x86_64-gsm
            mingw-w64-ucrt-x86_64-libbluray
            mingw-w64-ucrt-x86_64-libgme
            mingw-w64-ucrt-x86_64-libopenmpt
            mingw-w64-ucrt-x86_64-rubberband
            mingw-w64-ucrt-x86_64-libsrt
            mingw-w64-ucrt-x86_64-libssh
            mingw-w64-ucrt-x86_64-libxml2
            mingw-w64-ucrt-x86_64-xz
            mingw-w64-ucrt-x86_64-snappy
            mingw-w64-ucrt-x86_64-openjpeg2
            mingw-w64-ucrt-x86_64-openal
            mingw-w64-ucrt-x86_64-libbs2b
            mingw-w64-ucrt-x86_64-libcaca
            mingw-w64-ucrt-x86_64-libmodplug
            mingw-w64-ucrt-x86_64-lilv
            mingw-w64-ucrt-x86_64-libmysofa
            mingw-w64-ucrt-x86_64-librsvg
            mingw-w64-ucrt-x86_64-tesseract-ocr
            mingw-w64-ucrt-x86_64-chromaprint
            mingw-w64-ucrt-x86_64-frei0r-plugins
            mingw-w64-ucrt-x86_64-libplacebo
            mingw-w64-ucrt-x86_64-vulkan-headers
            mingw-w64-ucrt-x86_64-shaderc
            mingw-w64-ucrt-x86_64-libvmaf
            mingw-w64-ucrt-x86_64-librist
            mingw-w64-ucrt-x86_64-aribb24
            mingw-w64-ucrt-x86_64-opencore-amr
            mingw-w64-ucrt-x86_64-vo-amrwbenc
            mingw-w64-ucrt-x86_64-shine
            mingw-w64-ucrt-x86_64-xvidcore
            mingw-w64-ucrt-x86_64-zvbi

      - name: Setup MSYS2 ARM64 (Windows ARM64)
        if: matrix.target == 'windows' && matrix.arch == 'arm64'
        uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          update: true
          install: >-
            base-devel
            mingw-w64-clang-aarch64-toolchain
            mingw-w64-clang-aarch64-cmake
            mingw-w64-clang-aarch64-meson
            mingw-w64-clang-aarch64-ninja
            mingw-w64-clang-aarch64-pkg-config
            zip
            wget
            git

      # ============================================
      # MACOS DEPENDENCIES
      # ============================================
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install \
            nasm \
            yasm \
            pkg-config \
            cmake \
            meson \
            ninja \
            texinfo \
            wget \
            zip \
            \
            x264 \
            x265 \
            libvpx \
            fdk-aac \
            lame \
            opus \
            libvorbis \
            theora \
            libass \
            freetype \
            fontconfig \
            fribidi \
            harfbuzz \
            gnutls \
            sdl2 \
            aom \
            dav1d \
            rav1e \
            svt-av1 \
            webp \
            soxr \
            libvidstab \
            zimg \
            zeromq \
            speex \
            two-lame \
            wavpack \
            libgsm \
            libbluray \
            game-music-emu \
            libopenmpt \
            rubberband \
            srt \
            libssh \
            libxml2 \
            xz \
            snappy \
            openjpeg \
            openal-soft \
            libbs2b \
            libcaca \
            jack \
            libmodplug \
            lilv \
            libmysofa \
            librsvg \
            tesseract \
            chromaprint \
            frei0r \
            libplacebo \
            vulkan-headers \
            molten-vk \
            shaderc \
            libvmaf \
            librist \
            aribb24

      # ============================================
      # DOWNLOAD FFMPEG SOURCE
      # ============================================
      - name: Download FFmpeg source (Linux/macOS)
        if: matrix.target != 'windows'
        run: |
          curl -L "https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz" -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      - name: Download FFmpeg source (Windows)
        if: matrix.target == 'windows'
        shell: msys2 {0}
        run: |
          curl -L "https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz" -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      # ============================================
      # CONFIGURE FFMPEG
      # ============================================
      - name: Configure FFmpeg (Linux)
        if: matrix.target == 'linux'
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-lto \
            --enable-pthreads \
            --enable-chromaprint \
            --enable-frei0r \
            --enable-ladspa \
            --enable-libaom \
            --enable-libaribb24 \
            --enable-libass \
            --enable-libbluray \
            --enable-libbs2b \
            --enable-libcaca \
            --enable-libcdio \
            --enable-libdav1d \
            --enable-libfdk-aac \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libharfbuzz \
            --enable-libgme \
            --enable-libgsm \
            --enable-libjack \
            --enable-liblc3 \
            --enable-libmodplug \
            --enable-libmp3lame \
            --enable-libmysofa \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libopenjpeg \
            --enable-libopenmpt \
            --enable-libopus \
            --enable-libplacebo \
            --enable-libpulse \
            --enable-librav1e \
            --enable-librist \
            --enable-librsvg \
            --enable-librubberband \
            --enable-libshine \
            --enable-libsnappy \
            --enable-libsoxr \
            --enable-libspeex \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsvtav1 \
            --enable-libtesseract \
            --enable-libtheora \
            --enable-libtwolame \
            --enable-libv4l2 \
            --enable-libvidstab \
            --enable-libvmaf \
            --enable-libvo-amrwbenc \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libwavpack \
            --enable-libwebp \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libxcb \
            --enable-libxcb-shm \
            --enable-libxcb-xfixes \
            --enable-libxcb-shape \
            --enable-libxvid \
            --enable-libxml2 \
            --enable-libzimg \
            --enable-libzmq \
            --enable-libzvbi \
            --enable-lv2 \
            --enable-gnutls \
            --enable-openal \
            --enable-opencl \
            --enable-vulkan \
            --enable-libshaderc \
            --enable-libdrm \
            --enable-vaapi \
            --enable-vdpau

      - name: Configure FFmpeg (Windows x86_64)
        if: matrix.target == 'windows' && matrix.arch == 'x86_64'
        shell: msys2 {0}
        run: |
          cd ffmpeg-src
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-lto \
            --enable-pthreads \
            --enable-chromaprint \
            --enable-frei0r \
            --enable-libaom \
            --enable-libaribb24 \
            --enable-libass \
            --enable-libbluray \
            --enable-libbs2b \
            --enable-libcaca \
            --enable-libdav1d \
            --enable-libfdk-aac \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libharfbuzz \
            --enable-libgme \
            --enable-libgsm \
            --enable-libmodplug \
            --enable-libmp3lame \
            --enable-libmysofa \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libopenjpeg \
            --enable-libopenmpt \
            --enable-libopus \
            --enable-libplacebo \
            --enable-librav1e \
            --enable-librist \
            --enable-librsvg \
            --enable-librubberband \
            --enable-libshine \
            --enable-libsnappy \
            --enable-libsoxr \
            --enable-libspeex \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsvtav1 \
            --enable-libtesseract \
            --enable-libtheora \
            --enable-libtwolame \
            --enable-libvidstab \
            --enable-libvmaf \
            --enable-libvo-amrwbenc \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libwavpack \
            --enable-libwebp \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libxvid \
            --enable-libxml2 \
            --enable-libzimg \
            --enable-libzmq \
            --enable-libzvbi \
            --enable-lv2 \
            --enable-gnutls \
            --enable-openal \
            --enable-opencl \
            --enable-vulkan \
            --enable-libshaderc \
            --enable-d3d11va \
            --enable-dxva2

      - name: Configure FFmpeg (Windows ARM64)
        if: matrix.target == 'windows' && matrix.arch == 'arm64'
        shell: msys2 {0}
        run: |
          cd ffmpeg-src
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic

      - name: Configure FFmpeg (macOS)
        if: matrix.target == 'macos'
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-lto \
            --enable-pthreads \
            --enable-chromaprint \
            --enable-frei0r \
            --enable-libaom \
            --enable-libaribb24 \
            --enable-libass \
            --enable-libbluray \
            --enable-libbs2b \
            --enable-libcaca \
            --enable-libdav1d \
            --enable-libfdk-aac \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libharfbuzz \
            --enable-libgme \
            --enable-libgsm \
            --enable-libjack \
            --enable-libmodplug \
            --enable-libmp3lame \
            --enable-libmysofa \
            --enable-libopenjpeg \
            --enable-libopenmpt \
            --enable-libopus \
            --enable-libplacebo \
            --enable-librav1e \
            --enable-librist \
            --enable-librsvg \
            --enable-librubberband \
            --enable-libshine \
            --enable-libsnappy \
            --enable-libsoxr \
            --enable-libspeex \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsvtav1 \
            --enable-libtesseract \
            --enable-libtheora \
            --enable-libtwolame \
            --enable-libvidstab \
            --enable-libvmaf \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libwavpack \
            --enable-libwebp \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libxvid \
            --enable-libxml2 \
            --enable-libzimg \
            --enable-libzmq \
            --enable-lv2 \
            --enable-gnutls \
            --enable-openal \
            --enable-opencl \
            --enable-vulkan \
            --enable-libshaderc \
            --enable-videotoolbox \
            --enable-audiotoolbox \
            --enable-metal \
            --extra-cflags="-I$(brew --prefix)/include" \
            --extra-ldflags="-L$(brew --prefix)/lib"

      # # Android configure (commented out)
      # - name: Configure FFmpeg (Android)
      #   if: matrix.target == 'android'
      #   working-directory: ffmpeg-src
      #   env:
      #     NDK_PATH: ${{ steps.setup-ndk.outputs.ndk-path }}
      #   run: |
      #     TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
      #     API=24
      #     if [ "${{ matrix.arch }}" = "arm64" ]; then
      #       TARGET=aarch64-linux-android
      #       ARCH=aarch64
      #     else
      #       TARGET=x86_64-linux-android
      #       ARCH=x86_64
      #     fi
      #     ./configure \
      #       --prefix="${{ github.workspace }}/ffmpeg-build" \
      #       --enable-gpl \
      #       --enable-version3 \
      #       --enable-nonfree \
      #       --enable-shared \
      #       --disable-static \
      #       --enable-pic \
      #       --enable-cross-compile \
      #       --arch=$ARCH \
      #       --target-os=android \
      #       --cc="$TOOLCHAIN/bin/${TARGET}${API}-clang" \
      #       --cxx="$TOOLCHAIN/bin/${TARGET}${API}-clang++" \
      #       --cross-prefix="$TOOLCHAIN/bin/llvm-" \
      #       --sysroot="$TOOLCHAIN/sysroot" \
      #       --enable-jni \
      #       --enable-mediacodec

      # ============================================
      # BUILD FFMPEG
      # ============================================
      - name: Build FFmpeg (Linux/macOS)
        if: matrix.target != 'windows'
        working-directory: ffmpeg-src
        run: |
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install

      - name: Build FFmpeg (Windows)
        if: matrix.target == 'windows'
        shell: msys2 {0}
        run: |
          cd ffmpeg-src
          make -j$(nproc)
          make install

      # ============================================
      # PACKAGE BINARIES
      # ============================================
      - name: Create version.cfg
        shell: bash
        run: |
          echo "${{ env.FFMPEG_VERSION }}" > "${{ github.workspace }}/ffmpeg-build/version.cfg"

      - name: Package binaries (Linux)
        if: matrix.target == 'linux'
        run: |
          cd "${{ github.workspace }}/ffmpeg-build"
          mkdir -p staging
          
          # Copy binaries
          cp -P bin/* staging/ 2>/dev/null || true
          
          # Copy shared libraries
          cp -P lib/*.so* staging/ 2>/dev/null || true
          
          # Copy version file
          cp version.cfg staging/
          
          # Create zip with maximum compression (flat structure)
          cd staging
          zip -9 "${{ github.workspace }}/${{ matrix.artifact_name }}" *

      - name: Package binaries (Windows)
        if: matrix.target == 'windows'
        shell: msys2 {0}
        run: |
          cd "${{ github.workspace }}/ffmpeg-build"
          mkdir -p staging
          
          # Copy binaries
          cp -P bin/*.exe staging/ 2>/dev/null || true
          
          # Copy DLLs from bin and lib
          cp -P bin/*.dll staging/ 2>/dev/null || true
          cp -P lib/*.dll staging/ 2>/dev/null || true
          
          # Also copy required MSYS2 runtime DLLs
          for dll in $(ldd staging/*.exe 2>/dev/null | grep -i mingw | awk '{print $3}' | sort -u); do
            cp -P "$dll" staging/ 2>/dev/null || true
          done
          
          # Copy version file
          cp version.cfg staging/
          
          # Create zip with maximum compression (flat structure)
          cd staging
          zip -9 "${{ github.workspace }}/${{ matrix.artifact_name }}" *

      - name: Package binaries (macOS)
        if: matrix.target == 'macos'
        run: |
          cd "${{ github.workspace }}/ffmpeg-build"
          mkdir -p staging
          
          # Copy binaries
          cp -P bin/* staging/ 2>/dev/null || true
          
          # Copy shared libraries
          cp -P lib/*.dylib* staging/ 2>/dev/null || true
          
          # Copy version file
          cp version.cfg staging/
          
          # Create zip with maximum compression (flat structure)
          cd staging
          zip -9 "${{ github.workspace }}/${{ matrix.artifact_name }}" *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/${{ matrix.artifact_name }}
          retention-days: 1

  # ============================================
  # COMMIT BINARIES
  # ============================================
  commit-binaries:
    needs: build
    runs-on: ubuntu-latest
    name: Commit FFmpeg binaries

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Remove old binaries
        run: |
          rm -f src/main/resources/libs/ffmpeg-*.zip

      - name: Move new binaries
        run: |
          mkdir -p src/main/resources/libs
          
          # Move each artifact zip to the correct location
          for artifact_dir in artifacts/*/; do
            artifact_name=$(basename "$artifact_dir")
            if [ -f "${artifact_dir}${artifact_name}" ]; then
              mv "${artifact_dir}${artifact_name}" src/main/resources/libs/
            fi
          done
          
          # List what we moved
          ls -la src/main/resources/libs/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add src/main/resources/libs/ffmpeg-*.zip
          git commit -m "chore: update FFmpeg binaries to ${{ inputs.ffmpeg_version }}" || echo "No changes to commit"
          git push