name: FFmpeg macOS x64

on:
  workflow_call:
    inputs:
      ffmpeg_version:
        required: true
        type: string

env:
  FFMPEG_VERSION: ${{ inputs.ffmpeg_version }}

jobs:
  build:
    runs-on: macos-13
    name: Build macOS x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update || true
          
          # Core codecs and libraries
          brew install nasm yasm pkg-config cmake meson ninja wget zip \
            x264 x265 libvpx theora xvid aom dav1d rav1e svt-av1 \
            fdk-aac lame opus libvorbis speex \
            libass freetype fontconfig fribidi harfbuzz \
            libbluray webp openjpeg snappy libxml2 \
            gnutls srt libssh \
            libsoxr libvidstab zimg zeromq rubberband \
            sdl2 libbs2b libcaca game-music-emu || true
          
          echo "Installed packages:"
          brew list

      - name: Download FFmpeg source
        run: |
          curl -L "https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz" -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      - name: Configure FFmpeg
        working-directory: ffmpeg-src
        run: |
          BREW_PREFIX="$(brew --prefix)"
          
          # Build PKG_CONFIG_PATH for all installed packages
          PKG_PATHS=""
          EXTRA_CFLAGS=""
          EXTRA_LDFLAGS=""
          
          for pkg in x264 x265 libvpx aom dav1d rav1e svt-av1 \
                     fdk-aac lame opus libvorbis speex \
                     libass freetype fontconfig fribidi harfbuzz \
                     libbluray webp openjpeg snappy libxml2 \
                     gnutls srt libssh \
                     libsoxr libvidstab zimg zeromq rubberband \
                     sdl2 libbs2b libcaca game-music-emu theora xvid; do
            if brew --prefix "$pkg" &>/dev/null; then
              PKG_PREFIX="$(brew --prefix "$pkg")"
              if [ -d "$PKG_PREFIX/lib/pkgconfig" ]; then
                PKG_PATHS="$PKG_PREFIX/lib/pkgconfig:$PKG_PATHS"
              fi
              if [ -d "$PKG_PREFIX/include" ]; then
                EXTRA_CFLAGS="$EXTRA_CFLAGS -I$PKG_PREFIX/include"
              fi
              if [ -d "$PKG_PREFIX/lib" ]; then
                EXTRA_LDFLAGS="$EXTRA_LDFLAGS -L$PKG_PREFIX/lib"
              fi
            fi
          done
          
          export PKG_CONFIG_PATH="$PKG_PATHS$BREW_PREFIX/lib/pkgconfig:$BREW_PREFIX/share/pkgconfig"
          
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-pthreads \
            --disable-doc \
            --disable-htmlpages \
            --disable-manpages \
            --disable-podpages \
            --disable-txtpages \
            --disable-debug \
            --enable-videotoolbox \
            --enable-audiotoolbox \
            --enable-libaom \
            --enable-libass \
            --enable-libdav1d \
            --enable-libfdk-aac \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libharfbuzz \
            --enable-libmp3lame \
            --enable-libopus \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libtheora \
            --enable-libwebp \
            --enable-libxml2 \
            --enable-gnutls \
            --enable-librav1e \
            --enable-libsvtav1 \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsoxr \
            --enable-libvidstab \
            --enable-libzimg \
            --enable-libzmq \
            --enable-librubberband \
            --enable-libspeex \
            --enable-libbluray \
            --enable-libbs2b \
            --enable-libcaca \
            --enable-libgme \
            --enable-libsnappy \
            --enable-libopenjpeg \
            --enable-libxvid \
            --extra-cflags="-I$BREW_PREFIX/include $EXTRA_CFLAGS" \
            --extra-ldflags="-L$BREW_PREFIX/lib $EXTRA_LDFLAGS"

      - name: Build FFmpeg
        working-directory: ffmpeg-src
        run: |
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Test binaries
        run: |
          ${{ github.workspace }}/ffmpeg-build/bin/ffmpeg -version
          ${{ github.workspace }}/ffmpeg-build/bin/ffprobe -version

      - name: Package binaries
        run: |
          cd "${{ github.workspace }}/ffmpeg-build"
          mkdir -p package
          cp lib/*.dylib package/ 2>/dev/null || true
          echo "${{ env.FFMPEG_VERSION }}" > package/version.cfg
          cd package
          zip -r ../ffmpeg-macos-x64.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x64
          path: ${{ github.workspace }}/ffmpeg-build/ffmpeg-macos-x64.zip
          retention-days: 7
