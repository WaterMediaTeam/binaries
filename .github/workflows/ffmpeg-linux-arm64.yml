name: FFmpeg Linux ARM64

on:
  workflow_call:
    inputs:
      ffmpeg_version:
        required: true
        type: string

env:
  FFMPEG_VERSION: ${{ inputs.ffmpeg_version }}

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    name: Build Linux ARM64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get upgrade
          sudo apt-get install -y \
            build-essential nasm yasm pkg-config git cmake meson ninja-build \
            texinfo wget curl zip python3 \
            libx264-dev libx265-dev libvpx-dev libmp3lame-dev \
            libopus-dev libvorbis-dev libtheora-dev libass-dev libfreetype-dev \
            libfontconfig1-dev libfribidi-dev libharfbuzz-dev libgnutls28-dev \
            libsdl2-dev libaom-dev libdav1d-dev libwebp-dev libsoxr-dev \
            libzimg-dev libzmq3-dev libspeex-dev libtwolame-dev \
            libgsm1-dev libbluray-dev libgme-dev libopenmpt-dev librubberband-dev \
            libsrt-gnutls-dev libssh-dev libxml2-dev liblzma-dev libsnappy-dev \
            libopenjp2-7-dev ocl-icd-opencl-dev libbs2b-dev libcaca-dev \
            libjack-dev libmodplug-dev libmysofa-dev librsvg2-dev libtesseract-dev \
            libdrm-dev libva-dev libvdpau-dev libxcb1-dev libxcb-shm0-dev \
            libxcb-xfixes0-dev libxvidcore-dev libchromaprint-dev frei0r-plugins-dev \
            ladspa-sdk libopencore-amrnb-dev libopencore-amrwb-dev libjxl-dev \
            libshine-dev libcodec2-dev libopenh264-dev \
            libvo-amrwbenc-dev librist-dev liblilv-dev lv2-dev \
            libgmp-dev libssl-dev

      - name: Cache compiled dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            /usr/local/lib
            /usr/local/include
            /usr/local/lib/pkgconfig
          key: linux-arm64-deps-v3-${{ hashFiles('.github/workflows/ffmpeg-linux-arm64.yml') }}

      - name: Build libvmaf from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/Netflix/vmaf.git
          cd vmaf/libvmaf
          meson setup build --buildtype=release --default-library=shared -Denable_tests=false -Denable_docs=false
          ninja -C build
          sudo ninja -C build install
          sudo ldconfig

      - name: Setup Rust toolchain
        if: steps.cache-deps.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build rav1e from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cargo install cargo-c
          git clone --depth 1 --branch v0.7.1 https://github.com/xiph/rav1e.git
          cd rav1e
          mkdir -p "$HOME/rav1e-install"
          cargo cinstall --release --prefix=/usr/local --destdir="$HOME/rav1e-install" --libdir=/usr/local/lib
          sudo cp -r "$HOME/rav1e-install/usr/local/lib/"* /usr/local/lib/ || true
          sudo cp -r "$HOME/rav1e-install/usr/local/include/"* /usr/local/include/ || true
          PC_FILE=$(find "$HOME/rav1e-install" -name "rav1e.pc" -type f | head -1)
          if [ -n "$PC_FILE" ]; then
            sudo mkdir -p /usr/local/lib/pkgconfig
            sudo cp "$PC_FILE" /usr/local/lib/pkgconfig/
            sudo sed -i 's|^prefix=.*|prefix=/usr/local|' /usr/local/lib/pkgconfig/rav1e.pc
            sudo sed -i 's|^libdir=.*|libdir=/usr/local/lib|' /usr/local/lib/pkgconfig/rav1e.pc
          fi
          sudo ldconfig
          pkg-config --modversion rav1e && echo "rav1e installed successfully"

      - name: Build SVT-AV1 from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://gitlab.com/AOMediaCodec/SVT-AV1.git
          cd SVT-AV1/Build
          cmake .. -G"Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Build kvazaar from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/ultravideo/kvazaar.git
          cd kvazaar/build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Restore cached libraries
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: |
          sudo ldconfig
          echo "Using cached dependencies"

      - name: Download FFmpeg source
        run: |
          curl -L "https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz" -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      - name: Save configure help
        working-directory: ffmpeg-src
        run: |
          ./configure --help > "${{ github.workspace }}/configure-help-linux-arm64.txt"

      - name: Configure FFmpeg
        working-directory: ffmpeg-src
        run: |
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
          export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
          
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-pthreads \
            --disable-doc \
            --disable-htmlpages \
            --disable-manpages \
            --disable-podpages \
            --disable-txtpages \
            --disable-debug \
            --enable-chromaprint \
            --enable-frei0r \
            --enable-ladspa \
            --enable-libaom \
            --enable-libass \
            --enable-libbluray \
            --enable-libbs2b \
            --enable-libcaca \
            --enable-libcodec2 \
            --enable-libdav1d \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libharfbuzz \
            --enable-libgme \
            --enable-libgsm \
            --enable-libjack \
            --enable-libkvazaar \
            --enable-libmodplug \
            --enable-libmp3lame \
            --enable-libmysofa \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libopenh264 \
            --enable-libopenjpeg \
            --enable-libopenmpt \
            --enable-libopus \
            --enable-librav1e \
            --enable-librist \
            --enable-librsvg \
            --enable-librubberband \
            --enable-libshine \
            --enable-libsnappy \
            --enable-libsoxr \
            --enable-libspeex \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsvtav1 \
            --enable-libtesseract \
            --enable-libtheora \
            --enable-libtwolame \
            --enable-libvmaf \
            --enable-libvo-amrwbenc \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libwebp \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libxvid \
            --enable-libxml2 \
            --enable-libzimg \
            --enable-libzmq \
            --enable-libjxl \
            --enable-lv2 \
            --enable-openssl \
            --enable-gmp \
            --enable-opencl \
            --enable-vaapi \
            --enable-vdpau \
            --enable-libdrm \
            --enable-v4l2-m2m \
            --enable-jni

      - name: Build FFmpeg
        working-directory: ffmpeg-src
        run: |
          export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
          make -j$(nproc)
          make install

      - name: Test binaries
        run: |
          export LD_LIBRARY_PATH="${{ github.workspace }}/ffmpeg-build/lib:/usr/local/lib:$LD_LIBRARY_PATH"
          ${{ github.workspace }}/ffmpeg-build/bin/ffmpeg -version
          ${{ github.workspace }}/ffmpeg-build/bin/ffprobe -version

      - name: Package binaries
        run: |
          cd "${{ github.workspace }}/ffmpeg-build"
          mkdir -p package
          cp lib/*.so* package/ 2>/dev/null || true
          echo "${{ env.FFMPEG_VERSION }}" > package/version.cfg
          cd package
          zip -r ../ffmpeg-linux-arm64.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-arm64
          path: ${{ github.workspace }}/ffmpeg-build/ffmpeg-linux-arm64.zip
          retention-days: 7

      - name: Upload configure help
        uses: actions/upload-artifact@v4
        with:
          name: configure-help-linux-arm64
          path: ${{ github.workspace }}/configure-help-linux-arm64.txt
          retention-days: 7
