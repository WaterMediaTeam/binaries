name: FFmpeg Test Binaries

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["FFmpeg Build"]
    types:
      - completed

jobs:
  test:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (native runners)
          - os: ubuntu-24.04
            target: linux
            arch: x86_64
            zip_name: ffmpeg-linux.zip
            binary: ffmpeg
            probe: ffprobe
          - os: ubuntu-24.04-arm
            target: linux
            arch: arm64
            zip_name: ffmpeg-linux-arm64.zip
            binary: ffmpeg
            probe: ffprobe

          # Windows (native runners)
          - os: windows-2025
            target: windows
            arch: x86_64
            zip_name: ffmpeg-windows.zip
            binary: ffmpeg.exe
            probe: ffprobe.exe
          - os: windows-11-arm
            target: windows
            arch: arm64
            zip_name: ffmpeg-windows-arm64.zip
            binary: ffmpeg.exe
            probe: ffprobe.exe

          # macOS (native runners)
          - os: macos-15-intel
            target: macos
            arch: x86_64
            zip_name: ffmpeg-macos.zip
            binary: ffmpeg
            probe: ffprobe
          - os: macos-15
            target: macos
            arch: arm64
            zip_name: ffmpeg-macos-arm64.zip
            binary: ffmpeg
            probe: ffprobe

          # # Android (commented out - requires emulator)
          # - os: ubuntu-24.04
          #   target: android
          #   arch: x86_64
          #   zip_name: ffmpeg-android.zip
          #   binary: ffmpeg
          #   probe: ffprobe
          # - os: ubuntu-24.04-arm
          #   target: android
          #   arch: arm64
          #   zip_name: ffmpeg-android-arm64.zip
          #   binary: ffmpeg
          #   probe: ffprobe

    runs-on: ${{ matrix.os }}
    name: Test FFmpeg (${{ matrix.target }}-${{ matrix.arch }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create extraction directory
        shell: bash
        run: mkdir -p ffmpeg-test

      - name: Extract binaries (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          unzip -o "src/main/resources/libs/${{ matrix.zip_name }}" -d ffmpeg-test
          chmod +x ffmpeg-test/*

      - name: Extract binaries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Expand-Archive -Path "src/main/resources/libs/${{ matrix.zip_name }}" -DestinationPath ffmpeg-test -Force

      - name: Verify version.cfg exists
        shell: bash
        run: |
          echo "=== Checking version.cfg ==="
          if [ -f "ffmpeg-test/version.cfg" ]; then
            echo "✓ version.cfg found"
            echo "FFmpeg version: $(cat ffmpeg-test/version.cfg)"
          else
            echo "✗ version.cfg not found!"
            exit 1
          fi

      - name: List extracted files
        shell: bash
        run: |
          echo "=== Extracted files ==="
          ls -la ffmpeg-test/

      - name: Test ffmpeg binary
        shell: bash
        run: |
          echo "=== Testing ffmpeg ==="
          ./ffmpeg-test/${{ matrix.binary }} -version
          echo ""
          echo "=== FFmpeg build configuration ==="
          ./ffmpeg-test/${{ matrix.binary }} -buildconf || true

      - name: Test ffprobe binary
        shell: bash
        run: |
          echo "=== Testing ffprobe ==="
          ./ffmpeg-test/${{ matrix.probe }} -version

      - name: Test ffplay binary (if exists)
        shell: bash
        continue-on-error: true
        run: |
          if [ -f "ffmpeg-test/ffplay" ] || [ -f "ffmpeg-test/ffplay.exe" ]; then
            echo "=== Testing ffplay ==="
            ./ffmpeg-test/ffplay* -version 2>/dev/null || echo "ffplay present but may require display"
          else
            echo "ffplay not included in build"
          fi

      - name: List available decoders
        shell: bash
        run: |
          echo "=== Available decoders (count) ==="
          DECODER_COUNT=$(./ffmpeg-test/${{ matrix.binary }} -decoders 2>/dev/null | grep -c "^ D" || echo "0")
          echo "Total decoders: $DECODER_COUNT"
          echo ""
          echo "=== Sample decoders ==="
          ./ffmpeg-test/${{ matrix.binary }} -decoders 2>/dev/null | head -30

      - name: List available encoders
        shell: bash
        run: |
          echo "=== Available encoders (count) ==="
          ENCODER_COUNT=$(./ffmpeg-test/${{ matrix.binary }} -encoders 2>/dev/null | grep -c "^ E" || echo "0")
          echo "Total encoders: $ENCODER_COUNT"
          echo ""
          echo "=== Sample encoders ==="
          ./ffmpeg-test/${{ matrix.binary }} -encoders 2>/dev/null | head -30

      - name: List available formats
        shell: bash
        run: |
          echo "=== Available formats (count) ==="
          FORMAT_COUNT=$(./ffmpeg-test/${{ matrix.binary }} -formats 2>/dev/null | grep -c "^ [DE]" || echo "0")
          echo "Total formats: $FORMAT_COUNT"

      - name: List available filters
        shell: bash
        run: |
          echo "=== Available filters (count) ==="
          FILTER_COUNT=$(./ffmpeg-test/${{ matrix.binary }} -filters 2>/dev/null | grep -c "^ [TSC]" || echo "0")
          echo "Total filters: $FILTER_COUNT"

      - name: List hardware acceleration
        shell: bash
        run: |
          echo "=== Hardware acceleration methods ==="
          ./ffmpeg-test/${{ matrix.binary }} -hwaccels 2>/dev/null || true

      - name: Verify shared libraries are present (Linux)
        if: matrix.target == 'linux'
        run: |
          echo "=== Checking shared libraries ==="
          ls -la ffmpeg-test/*.so* 2>/dev/null | head -20 || echo "No .so files found"
          echo ""
          echo "=== Library dependencies ==="
          ldd ffmpeg-test/${{ matrix.binary }} 2>/dev/null | head -30 || true

      - name: Verify shared libraries are present (macOS)
        if: matrix.target == 'macos'
        run: |
          echo "=== Checking shared libraries ==="
          ls -la ffmpeg-test/*.dylib* 2>/dev/null | head -20 || echo "No .dylib files found"
          echo ""
          echo "=== Library dependencies ==="
          otool -L ffmpeg-test/${{ matrix.binary }} 2>/dev/null | head -30 || true

      - name: Verify shared libraries are present (Windows)
        if: matrix.target == 'windows'
        shell: bash
        run: |
          echo "=== Checking DLLs ==="
          ls -la ffmpeg-test/*.dll 2>/dev/null | head -20 || echo "No .dll files found"

      - name: Functional test - Generate test video (H.264 + AAC)
        shell: bash
        run: |
          echo "=== Generating test video (H.264 + AAC) ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "testsrc=duration=2:size=320x240:rate=30" \
            -f lavfi -i "sine=frequency=440:duration=2" \
            -c:v libx264 -c:a aac \
            -y test_h264.mp4
          
          echo ""
          echo "=== Analyzing generated video ==="
          ./ffmpeg-test/${{ matrix.probe }} -v quiet -show_format -show_streams test_h264.mp4

      - name: Functional test - VP9 + Opus (WebM)
        shell: bash
        continue-on-error: true
        run: |
          echo "=== Generating WebM (VP9 + Opus) ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "testsrc=duration=1:size=320x240:rate=30" \
            -f lavfi -i "sine=frequency=440:duration=1" \
            -c:v libvpx-vp9 -c:a libopus \
            -y test_vp9.webm
          
          ./ffmpeg-test/${{ matrix.probe }} -v quiet -show_format test_vp9.webm

      - name: Functional test - HEVC/H.265
        shell: bash
        continue-on-error: true
        run: |
          echo "=== Generating HEVC video ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "testsrc=duration=1:size=320x240:rate=30" \
            -c:v libx265 \
            -y test_hevc.mp4
          
          ./ffmpeg-test/${{ matrix.probe }} -v quiet -show_format test_hevc.mp4

      - name: Functional test - AV1 encoding
        shell: bash
        continue-on-error: true
        run: |
          echo "=== Generating AV1 video (may be slow) ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "testsrc=duration=1:size=320x240:rate=30" \
            -c:v libaom-av1 -cpu-used 8 -crf 50 \
            -y test_av1.mp4 || echo "AV1 encoding skipped or failed"

      - name: Functional test - MP3 encoding
        shell: bash
        continue-on-error: true
        run: |
          echo "=== Generating MP3 audio ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "sine=frequency=440:duration=2" \
            -c:a libmp3lame -b:a 192k \
            -y test.mp3
          
          ./ffmpeg-test/${{ matrix.probe }} -v quiet -show_format test.mp3

      - name: Functional test - Image sequence
        shell: bash
        run: |
          echo "=== Generating image sequence ==="
          ./ffmpeg-test/${{ matrix.binary }} \
            -f lavfi -i "testsrc=duration=1:size=320x240:rate=10" \
            -y frame_%03d.png
          
          ls -la frame_*.png | head -5

      - name: Test summary
        shell: bash
        run: |
          echo ""
          echo "=========================================="
          echo "✓ FFmpeg binaries test PASSED"
          echo "  Platform: ${{ matrix.target }}"
          echo "  Architecture: ${{ matrix.arch }}"
          echo "  Package: ${{ matrix.zip_name }}"
          echo "=========================================="