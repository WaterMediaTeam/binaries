name: FFmpeg Build Orchestrator

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1.3'
        type: string

jobs:
  linux-x64:
    uses: ./.github/workflows/ffmpeg-linux-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  linux-arm64:
    uses: ./.github/workflows/ffmpeg-linux-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-x64:
    uses: ./.github/workflows/ffmpeg-macos-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-arm64:
    uses: ./.github/workflows/ffmpeg-macos-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-x64:
    uses: ./.github/workflows/ffmpeg-windows-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-arm64:
    uses: ./.github/workflows/ffmpeg-windows-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  create-pr:
    if: always()
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    runs-on: ubuntu-latest
    name: Create Pull Request
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine build results
        id: results
        run: |
          PASSED=""
          FAILED=""
          
          check_result() {
            local name="$1"
            local result="$2"
            if [ "$result" == "success" ]; then
              PASSED="${PASSED}- ✅ ${name}\n"
            else
              FAILED="${FAILED}- ❌ ${name}\n"
            fi
          }
          
          check_result "Linux x64" "${{ needs.linux-x64.result }}"
          check_result "Linux ARM64" "${{ needs.linux-arm64.result }}"
          check_result "macOS x64" "${{ needs.macos-x64.result }}"
          check_result "macOS ARM64" "${{ needs.macos-arm64.result }}"
          check_result "Windows x64" "${{ needs.windows-x64.result }}"
          check_result "Windows ARM64" "${{ needs.windows-arm64.result }}"
          
          # Check if at least one build succeeded
          if [ -z "$PASSED" ]; then
            echo "has_success=false" >> $GITHUB_OUTPUT
          else
            echo "has_success=true" >> $GITHUB_OUTPUT
          fi
          
          echo -e "passed<<EOF\n${PASSED}EOF" >> $GITHUB_OUTPUT
          echo -e "failed<<EOF\n${FAILED}EOF" >> $GITHUB_OUTPUT

      - name: Download available artifacts
        if: steps.results.outputs.has_success == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Create branch and update binaries
        if: steps.results.outputs.has_success == 'true'
        run: |
          BRANCH_NAME="update-ffmpeg-${{ inputs.ffmpeg_version }}-$(date +%Y%m%d-%H%M%S)"
          LIBS_DIR="src/main/resources/libs"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          
          mkdir -p "$LIBS_DIR"
          
          rm -f "$LIBS_DIR"/*.zip
          echo "Removed old binaries"
          
          for platform in linux-x64 linux-arm64 macos-x64 macos-arm64 windows-x64 windows-arm64; do
            if [ -f "artifacts/ffmpeg-${platform}/ffmpeg-${platform}.zip" ]; then
              cp "artifacts/ffmpeg-${platform}/ffmpeg-${platform}.zip" "$LIBS_DIR/"
              echo "Copied ffmpeg-${platform}.zip"
            fi
          done
          
          echo "Copied binaries:"
          ls -la "$LIBS_DIR"/*.zip 2>/dev/null || echo "No zip files found"
          
          git add "$LIBS_DIR"
          git commit -m "Update FFmpeg binaries to ${{ inputs.ffmpeg_version }}"
          
          git push origin "$BRANCH_NAME"
          
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.results.outputs.has_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_BODY="## FFmpeg ${{ inputs.ffmpeg_version }} Binaries Update

          This PR updates the FFmpeg binaries to version **${{ inputs.ffmpeg_version }}**.

          ### Successful builds:
          ${{ steps.results.outputs.passed }}
          ### Failed builds:
          ${{ steps.results.outputs.failed }}
          ### Changes:
          - Removed old binary zip files from \`src/main/resources/libs\`
          - Added new FFmpeg ${{ inputs.ffmpeg_version }} binaries for successful platforms

          ---
          *This PR was automatically generated by the FFmpeg Build Orchestrator workflow.*"

          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Update FFmpeg binaries to ${{ inputs.ffmpeg_version }}" \
            --body "$PR_BODY"

      - name: Report all builds failed
        if: steps.results.outputs.has_success == 'false'
        run: |
          echo "::error::All platform builds failed. No PR will be created."
          echo "Failed builds:"
          echo "${{ steps.results.outputs.failed }}"
          exit 1
