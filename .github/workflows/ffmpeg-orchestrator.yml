name: FFmpeg Build Orchestrator

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1.3'
        type: string

jobs:
  linux-x64:
    uses: ./.github/workflows/ffmpeg-linux-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  linux-arm64:
    uses: ./.github/workflows/ffmpeg-linux-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-x64:
    uses: ./.github/workflows/ffmpeg-macos-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-arm64:
    uses: ./.github/workflows/ffmpeg-macos-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-x64:
    uses: ./.github/workflows/ffmpeg-windows-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-arm64:
    uses: ./.github/workflows/ffmpeg-windows-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  create-pr:
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    runs-on: ubuntu-latest
    name: Create Pull Request
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create branch and update binaries
        run: |
          BRANCH_NAME="update-ffmpeg-${{ inputs.ffmpeg_version }}-$(date +%Y%m%d-%H%M%S)"
          LIBS_DIR="src/main/resources/libs"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          # Create libs directory if it doesn't exist
          mkdir -p "$LIBS_DIR"
          
          # Remove old zip files
          rm -f "$LIBS_DIR"/*.zip
          echo "Removed old binaries"
          
          # Copy new zip files
          find artifacts -name "*.zip" -exec cp {} "$LIBS_DIR/" \;
          echo "Copied new binaries:"
          ls -la "$LIBS_DIR"/*.zip
          
          # Commit changes
          git add "$LIBS_DIR"
          git commit -m "Update FFmpeg binaries to ${{ inputs.ffmpeg_version }}"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Save branch name for PR step
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Update FFmpeg binaries to ${{ inputs.ffmpeg_version }}" \
            --body "## FFmpeg ${{ inputs.ffmpeg_version }} Binaries Update

          This PR updates the FFmpeg binaries to version **${{ inputs.ffmpeg_version }}**.

          ### Included platforms:
          - ✅ Linux x64
          - ✅ Linux ARM64
          - ✅ macOS x64
          - ✅ macOS ARM64
          - ✅ Windows x64
          - ✅ Windows ARM64

          ### Changes:
          - Removed old binary zip files from \`src/main/resources/libs\`
          - Added new FFmpeg ${{ inputs.ffmpeg_version }} binaries

          ---
          *This PR was automatically generated by the FFmpeg Build Orchestrator workflow.*"