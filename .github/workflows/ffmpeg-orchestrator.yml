name: FFmpeg Build Orchestrator

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1.3'
        type: string

jobs:
  linux-x64:
    uses: ./.github/workflows/ffmpeg-linux-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  linux-arm64:
    uses: ./.github/workflows/ffmpeg-linux-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-x64:
    uses: ./.github/workflows/ffmpeg-macos-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  macos-arm64:
    uses: ./.github/workflows/ffmpeg-macos-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-x64:
    uses: ./.github/workflows/ffmpeg-windows-x64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  windows-arm64:
    uses: ./.github/workflows/ffmpeg-windows-arm64.yml
    with:
      ffmpeg_version: ${{ inputs.ffmpeg_version }}

  create-release:
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    if: always()
    runs-on: ubuntu-latest
    name: Create Release Package

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.zip" | while read f; do
            echo "  - $f ($(du -h "$f" | cut -f1))"
          done

      - name: Create combined release
        run: |
          mkdir -p release
          
          # Move all zip files to release folder
          find artifacts -name "*.zip" -exec mv {} release/ \;
          
          # Create manifest
          echo "FFmpeg ${{ inputs.ffmpeg_version }} - Built $(date -u +%Y-%m-%d)" > release/BUILD_INFO.txt
          echo "" >> release/BUILD_INFO.txt
          echo "Contents:" >> release/BUILD_INFO.txt
          ls -la release/*.zip >> release/BUILD_INFO.txt 2>/dev/null || echo "No builds completed" >> release/BUILD_INFO.txt
          
          cat release/BUILD_INFO.txt

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ inputs.ffmpeg_version }}-all-platforms
          path: release/
          retention-days: 30
