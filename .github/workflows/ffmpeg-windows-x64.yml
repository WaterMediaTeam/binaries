name: FFmpeg Windows x64

on:
  workflow_call:
    inputs:
      ffmpeg_version:
        required: true
        type: string

env:
  FFMPEG_VERSION: ${{ inputs.ffmpeg_version }}

jobs:
  build:
    runs-on: windows-2025
    name: Build Windows x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            base-devel
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-nasm
            mingw-w64-ucrt-x86_64-pkgconf
            mingw-w64-ucrt-x86_64-libwinpthread
            zip
            wget
            git
            mingw-w64-ucrt-x86_64-aom
            mingw-w64-ucrt-x86_64-dav1d
            mingw-w64-ucrt-x86_64-rav1e
            mingw-w64-ucrt-x86_64-svt-av1
            mingw-w64-ucrt-x86_64-libx264
            mingw-w64-ucrt-x86_64-x265
            mingw-w64-ucrt-x86_64-libvpx
            mingw-w64-ucrt-x86_64-xvidcore
            mingw-w64-ucrt-x86_64-libtheora
            mingw-w64-ucrt-x86_64-libvorbis
            mingw-w64-ucrt-x86_64-opus
            mingw-w64-ucrt-x86_64-lame
            mingw-w64-ucrt-x86_64-fdk-aac
            mingw-w64-ucrt-x86_64-speex
            mingw-w64-ucrt-x86_64-gsm
            mingw-w64-ucrt-x86_64-opencore-amr
            mingw-w64-ucrt-x86_64-libwebp
            mingw-w64-ucrt-x86_64-libjxl
            mingw-w64-ucrt-x86_64-openjpeg2
            mingw-w64-ucrt-x86_64-libass
            mingw-w64-ucrt-x86_64-freetype
            mingw-w64-ucrt-x86_64-fontconfig
            mingw-w64-ucrt-x86_64-fribidi
            mingw-w64-ucrt-x86_64-harfbuzz
            mingw-w64-ucrt-x86_64-gnutls
            mingw-w64-ucrt-x86_64-gmp
            mingw-w64-ucrt-x86_64-SDL2
            mingw-w64-ucrt-x86_64-zimg
            mingw-w64-ucrt-x86_64-zvbi
            mingw-w64-ucrt-x86_64-libbluray
            mingw-w64-ucrt-x86_64-libgme
            mingw-w64-ucrt-x86_64-libmodplug
            mingw-w64-ucrt-x86_64-libsoxr
            mingw-w64-ucrt-x86_64-libssh
            mingw-w64-ucrt-x86_64-srt
            mingw-w64-ucrt-x86_64-vid.stab
            mingw-w64-ucrt-x86_64-libplacebo
            mingw-w64-ucrt-x86_64-librsvg
            mingw-w64-ucrt-x86_64-libxml2
            mingw-w64-ucrt-x86_64-libcaca
            mingw-w64-ucrt-x86_64-openal
            mingw-w64-ucrt-x86_64-frei0r-plugins
            mingw-w64-ucrt-x86_64-vulkan-headers
            mingw-w64-ucrt-x86_64-vulkan
            mingw-w64-ucrt-x86_64-shaderc
            mingw-w64-ucrt-x86_64-liblc3
            mingw-w64-ucrt-x86_64-snappy
            mingw-w64-ucrt-x86_64-xz
            mingw-w64-ucrt-x86_64-bzip2
            mingw-w64-ucrt-x86_64-zlib
            mingw-w64-ucrt-x86_64-rtmpdump

      - name: Download FFmpeg source
        shell: msys2 {0}
        run: |
          curl -L "https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz" -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          cd ffmpeg-src
          ./configure \
            --prefix="${{ github.workspace }}/ffmpeg-build" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-shared \
            --disable-static \
            --enable-pic \
            --enable-w32threads \
            --disable-doc \
            --disable-htmlpages \
            --disable-manpages \
            --disable-podpages \
            --disable-txtpages \
            --disable-debug \
            --enable-libaom \
            --enable-libass \
            --enable-libbluray \
            --enable-libcaca \
            --enable-libdav1d \
            --enable-libfdk-aac \
            --enable-libfontconfig \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libgme \
            --enable-libgsm \
            --enable-libharfbuzz \
            --enable-liblc3 \
            --enable-libmodplug \
            --enable-libmp3lame \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libopenjpeg \
            --enable-libopus \
            --enable-libplacebo \
            --enable-librav1e \
            --enable-librsvg \
            --enable-librtmp \
            --enable-libsnappy \
            --enable-libsoxr \
            --enable-libspeex \
            --enable-libsrt \
            --enable-libssh \
            --enable-libsvtav1 \
            --enable-libtheora \
            --enable-libvidstab \
            --enable-libvorbis \
            --enable-libvpx \
            --enable-libwebp \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libxml2 \
            --enable-libxvid \
            --enable-libzimg \
            --enable-libzvbi \
            --enable-gnutls \
            --enable-openal \
            --enable-vulkan \
            --enable-libshaderc \
            --enable-d3d11va \
            --enable-dxva2

      - name: Build FFmpeg
        shell: msys2 {0}
        run: |
          cd ffmpeg-src
          make -j$(nproc)
          make install

      - name: Test binaries
        shell: msys2 {0}
        run: |
          echo "Testing FFmpeg binaries..."
          # Convert Windows path to Unix path for MSYS2
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          "${WORKSPACE}/ffmpeg-build/bin/ffmpeg.exe" -version
          "${WORKSPACE}/ffmpeg-build/bin/ffprobe.exe" -version
          echo "Binary test passed!"

      - name: Package binaries
        shell: msys2 {0}
        run: |
          set -x
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          cd "${WORKSPACE}/ffmpeg-build"
          
          echo "Contents of ffmpeg-build:"
          ls -la
          ls -la bin/ || echo "No bin directory"
          
          mkdir -p package
          
          # Copy FFmpeg DLLs and EXEs
          cp bin/*.dll package/ 2>/dev/null || true
          cp bin/*.exe package/ 2>/dev/null || true
          
          # Copy dependency DLLs from MSYS2 (iterate until no new deps found)
          for iteration in 1 2 3 4 5; do
            echo "=== Dependency iteration $iteration ==="
            BEFORE=$(ls package/*.dll 2>/dev/null | wc -l)
          
            for dll in package/*.dll; do
              [ -f "$dll" ] || continue
              ldd "$dll" 2>/dev/null | grep -i ucrt64 | awk '{print $3}' | while read -r dep; do
                if [ -n "$dep" ] && [ -f "$dep" ]; then
                  base=$(basename "$dep")
                  if [ ! -f "package/$base" ]; then
                    cp "$dep" package/ 2>/dev/null || true
                  fi
                fi
              done
            done
          
            AFTER=$(ls package/*.dll 2>/dev/null | wc -l)
            echo "DLLs before: $BEFORE, after: $AFTER"
            [ "$BEFORE" -eq "$AFTER" ] && break
          done
          
          # Create version.cfg
          echo "${{ env.FFMPEG_VERSION }}" > package/version.cfg
          
          echo "Package contents:"
          ls package/ | head -50
          echo "Total files: $(ls package/ | wc -l)"
          
          # Create zip
          cd package
          zip -r ../ffmpeg-windows-x64.zip .
          
          echo "Zip created:"
          ls -la ../ffmpeg-windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x64
          path: ${{ github.workspace }}/ffmpeg-build/ffmpeg-windows-x64.zip
          retention-days: 7